# 🚨 部署故障快速排查

## 问题：部署后竞品动态页面没有数据

### 症状
- ✅ 构建成功（Build completed）
- ❌ 竞品动态页面显示"暂无数据"或"Supabase未配置"
- ❌ 浏览器控制台显示 API 错误

### 原因
**环境变量未配置！** 这是 99% 的部署问题的根本原因。

## ✅ 立即解决（3步）

### 第1步：登录 EdgeOne Pages 控制台

访问：https://console.cloud.tencent.com/edgeone/pages

### 第2步：配置环境变量

1. 找到项目 `ai-topic-radar`
2. 点击 **"设置"** → **"环境变量"**
3. 点击 **"添加环境变量"**
4. 逐个添加以下3个变量：

```
变量名：NEXT_PUBLIC_SUPABASE_URL
值：https://sdxgocjszjnrqrfbsspn.supabase.co
环境：✅ Production

变量名：NEXT_PUBLIC_SUPABASE_ANON_KEY
值：eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkeGdvY2pzempucnFyZmJzc3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5OTM4NjgsImV4cCI6MjA3NTU2OTg2OH0.8lJ8dCBTT3qwmwNdL71EMPcVAmZHAgBeEp3rr-X6GJU
环境：✅ Production

变量名：FIRECRAWL_API_KEY
值：fc-c34842bb4fd54a58a7b001c5369a3bcb
环境：✅ Production
```

### 第3步：重新部署

**方式A：在控制台重新部署**
1. 保存环境变量后
2. 点击 "部署" → "重新部署最新版本"

**方式B：推送新提交触发部署**
```bash
git commit --allow-empty -m "chore: trigger redeploy"
git push origin main
```

### 第4步：验证（等待2-3分钟）

访问你的网站：`https://你的域名.com/competitor-dynamics`

**预期结果**：
- ✅ 能看到竞品模板数据
- ✅ 右上角显示"最后更新时间"
- ✅ 可以使用搜索和筛选功能

## 🔍 仍然有问题？

### 检查清单

#### 1. 确认环境变量正确
```bash
# 在 EdgeOne Pages 控制台检查
✅ 变量名没有拼写错误
✅ 变量名包含 NEXT_PUBLIC_ 前缀
✅ 变量值没有多余的空格
✅ 应用到了 Production 环境
```

#### 2. 确认已重新部署
```bash
✅ 配置环境变量后触发了新的部署
✅ 部署状态显示"成功"
✅ 部署时间是最新的
```

#### 3. 检查浏览器控制台
打开浏览器开发者工具（F12）：
```
控制台（Console）：
  ✅ 没有红色错误信息
  ✅ /api/competitor-templates 返回 200

网络（Network）：
  ✅ API 请求返回 {"success": true}
  ❌ 如果返回 {"success": false, "error": "Supabase未配置"}
     → 说明环境变量没生效，回到第2步
```

#### 4. 测试 API 端点
```bash
# 在终端或浏览器访问
https://你的域名.com/api/competitor-templates

# 正常返回：
{
  "success": true,
  "data": {
    "platforms": [...]
  }
}

# 错误返回：
{
  "success": false,
  "error": "Supabase未配置"
}
```

## 📋 完整的环境变量列表

### 必需（缺一不可）
| 变量名 | 说明 | 
|--------|------|
| `NEXT_PUBLIC_SUPABASE_URL` | 数据库地址 |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | 数据库访问密钥 |
| `FIRECRAWL_API_KEY` | 爬虫API密钥 |

### 可选
| 变量名 | 说明 |
|--------|------|
| `DEEPSEEK_API_KEY` | AI功能（暂未使用）|

## 🎯 常见错误

### 错误1：忘记 NEXT_PUBLIC_ 前缀
```bash
❌ SUPABASE_URL=https://...
✅ NEXT_PUBLIC_SUPABASE_URL=https://...
```
Next.js 要求在客户端使用的环境变量必须有 `NEXT_PUBLIC_` 前缀。

### 错误2：配置后没有重新部署
```bash
❌ 只保存环境变量，期望立即生效
✅ 保存后必须重新部署
```
环境变量是在构建时注入的，修改后必须重新构建。

### 错误3：环境变量有多余空格
```bash
❌ "https://sdxgocjszjnrqrfbsspn.supabase.co "  # 末尾有空格
✅ "https://sdxgocjszjnrqrfbsspn.supabase.co"   # 没有空格
```

### 错误4：只配置到 Preview 环境
```bash
❌ 只勾选了 Preview
✅ 必须勾选 Production
```

## 📞 还需要帮助？

### 查看详细文档
- 📚 [EdgeOne 环境变量配置指南](./EdgeOne_环境变量配置指南.md)
- 📚 [完整部署指南](../DEPLOYMENT.md)

### 查看日志
1. EdgeOne Pages 控制台 → 部署历史
2. 点击最新部署 → 查看日志
3. 搜索关键词：`error`, `failed`, `Supabase`

### 本地测试
```bash
# 1. 创建本地环境变量文件
cat > .env.local << 'EOF'
NEXT_PUBLIC_SUPABASE_URL=https://sdxgocjszjnrqrfbsspn.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkeGdvY2pzempucnFyZmJzc3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5OTM4NjgsImV4cCI6MjA3NTU2OTg2OH0.8lJ8dCBTT3qwmwNdL71EMPcVAmZHAgBeEp3rr-X6GJU
FIRECRAWL_API_KEY=fc-c34842bb4fd54a58a7b001c5369a3bcb
EOF

# 2. 本地运行
npm install
npm run dev

# 3. 访问
open http://localhost:3000/competitor-dynamics

# 4. 如果本地正常，说明代码没问题，是部署环境的环境变量配置问题
```

## ✅ 成功标志

配置成功后，你应该看到：

1. ✅ 竞品动态页面显示多个模板卡片
2. ✅ 每个平台显示"更新时间"
3. ✅ 侧边栏显示"平台活跃度"统计
4. ✅ 可以使用搜索、筛选功能
5. ✅ 点击模板可以预览详情
6. ✅ 浏览器控制台没有错误

---

**最后更新**: 2025-10-22  
**问题解决率**: 99%（只要按步骤操作）

