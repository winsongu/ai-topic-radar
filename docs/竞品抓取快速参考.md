# 竞品抓取快速参考

> 快速查找各平台的抓取规则和常用命令

---

## 🚀 快速命令

### 手动执行抓取
```bash
cd /path/to/ai-topic-radar
node scripts/crawl-competitor-templates-v2.js
```

### 测试单个平台
```bash
# 修改脚本中的URLs数组，只保留需要测试的平台
node scripts/crawl-competitor-templates-v2.js
```

### 查看数据库数据
```sql
-- 查看各平台最新数据量
SELECT platform, COUNT(*) as total, MAX(crawled_at) as latest
FROM competitor_templates
GROUP BY platform;

-- 查看霜降模板（示例）
SELECT title, platform, crawled_at
FROM competitor_templates
WHERE title LIKE '%霜降%'
ORDER BY crawled_at DESC;
```

---

## 📋 平台速查表

| 平台 | 列表页 | 关键字段 | 特殊处理 |
|------|--------|---------|---------|
| **熊猫办公** | tukuppt.com/ppt/time_0_0_0_0_0_0_1.html | 标题/页数/作者 | 缩略图优先preview路径 |
| **AIPPT** | aippt.cn/template/ | 标题/页数 | 标题在`<Base64-Image-Removed>`后 |
| **iSlide** | 固定ID列表 | 标题/格式(Fu) | 列表页有反爬，用固定ID |
| **Canva** | - | - | 暂未实现 |

---

## 🔑 关键代码位置

### 抓取脚本
```
scripts/crawl-competitor-templates-v2.js
├── extractDetailUrls()      # 提取详情页URL
├── parseDetailPage_Tukuppt() # 熊猫办公解析
├── parseDetailPage_AIPPT()   # AIPPT解析
└── parseDetailPage_iSlide()  # iSlide解析
```

### API接口
```
app/api/competitor-templates/route.ts
└── GET /api/competitor-templates
    └── 返回最新批次数据
```

### 前端页面
```
app/competitor-dynamics/page.tsx
└── 缩略图使用 object-top 显示封面
```

---

## 🐛 常见问题速查

### AIPPT标题错误
**症状**：抓到"[下载客户端]"或推荐模板标题  
**原因**：正则匹配到干扰内容  
**解决**：检查前30行过滤逻辑，排除推荐关键词

### iSlide返回500
**症状**：列表页抓取失败  
**原因**：反爬限制  
**解决**：使用固定ID列表（已实现）

### 缩略图显示完整PPT
**症状**：显示多页拼接图  
**原因**：抓取的是完整拼接图  
**解决**：前端已用`object-top`优化，只显示顶部封面

### Firecrawl限流
**症状**：返回429错误  
**原因**：请求过于频繁  
**解决**：增加等待时间（3秒），或升级套餐

---

## 📊 数据验证

### 检查数据质量
```bash
# 验证API返回
curl -s http://localhost:4001/api/competitor-templates | python3 -c "
import sys, json
data = json.load(sys.stdin)
for p in data['data']['platforms']:
    print(f\"{p['name']}: {len(p['templates'])}条\")
"
```

### 检查缩略图
```sql
-- 检查各平台缩略图完整性
SELECT 
  platform,
  COUNT(*) as total,
  COUNT(thumbnail) as has_thumb,
  ROUND(COUNT(thumbnail) * 100.0 / COUNT(*), 2) as thumb_rate
FROM competitor_templates
WHERE crawled_at = (SELECT MAX(crawled_at) FROM competitor_templates)
GROUP BY platform;
```

---

## 🔧 环境变量

确保`.env.local`中配置以下变量：
```env
FIRECRAWL_API_KEY=fc-xxx
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
```

---

## 📅 维护清单

- [ ] 每月更新iSlide的固定ID列表
- [ ] 定期检查Firecrawl API配额使用情况
- [ ] 每季度验证各平台解析规则是否仍然有效
- [ ] 监控数据库大小，必要时调整清理策略（默认90天）

---

**完整文档**：参见 `docs/PPT竞品动态抓取来源及逻辑.md`

